name: Test Tcpdump Ubuntu
on:
  - push
jobs:
  test:
    name: Test Tcpdump Ubuntu
    runs-on: ubuntu-latest
    steps:
    - name: Test curl
      run: |
        set +e
        set -x
        curl --silent icanhazip.com
        sleep 5
        sudo tcpdump -i eth0 -s 65535 -w githubactions-ubuntu.pcap host 193.60.236.19 &
        sleep 2
        # Works
        curl --silent --show-error --local-port 2048 https://join.osmfoundation.org/ -o /dev/null
        # Fails
        curl --silent --show-error --local-port 2049 https://join.osmfoundation.org/ -o /dev/null
        curl --silent --show-error --local-port 2050 https://join.osmfoundation.org/ -o /dev/null
        curl --silent --show-error --local-port 2051 https://join.osmfoundation.org/ -o /dev/null
        curl --silent --show-error --local-port 2052 https://join.osmfoundation.org/ -o /dev/null
        curl --silent --show-error --local-port 2053 https://join.osmfoundation.org/ -o /dev/null
        curl --silent --show-error --local-port 2054 https://join.osmfoundation.org/ -o /dev/null
        curl --silent --show-error --local-port 2055 https://join.osmfoundation.org/ -o /dev/null
        sleep 5
        sudo killall -2 tcpdump
        sleep 1
    - name: Upload tcpdump
      if: ${{ always() }}
      uses: actions/upload-artifact@v1
      with:
        name: githubactions-ubuntu
        path: githubactions-ubuntu.pcap
